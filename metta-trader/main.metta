;; !(register-module! ../metta-trader)
!(import! &self rule-ops)
!(import! &self utils)
!(import! &self world)
!(import! &self planner)
!(import! &self schemas)
!(import! &self metta-trader:pln:engine)

(= (loop $contexts $money $ruleSpace) (
    let* (
        ($rules (collapse (get-atoms $ruleSpace)))
        ;; ($reasonedRules (pln-reasoning $rules))
        ;; ($_ (let $rule (superpose $reasonedRules) (add-reduct $rule $ruleSpace)))
        ($rules (collapse (get-atoms $ruleSpace)))
        ($applicableRules (getApplicableRules $contexts $money $rules))
        ($_ (println! (Applicable Rules: (size-atom $applicableRules))))
        ($selectedRule (thompson-sample $applicableRules))
        ($_ (println! (Selected Rule: (extractRule Id $selectedRule))))
        (($newContexts $newMoney) (applyRule $selectedRule $contexts))
        ($_ (println! (Updated: $newContexts $newMoney)))
        ($oldStateValue (evaluateState $contexts $money))
        ($newStateValue (evaluateState $newContexts $newMoney))
        ($reward (- $newStateValue $oldStateValue))
        ($updatedRule (updateRule $selectedRule $reward))
        ($_ (updateAtom $rule $updatedRule))
    )
    (loop $newContexts $newMoney $ruleSpace)
))

!("Loop Started")
!(bind! &ruleSpace (new-space))
!(initializeSpace &ruleSpace)

!(loop ((PLANET A)) 100 &ruleSpace)