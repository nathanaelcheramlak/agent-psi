!(import! &self rule-ops)
!(import! &self utils)
!(import! &self world)
!(import! &self planner)
!(import! &self planner-utils)
!(import! &self schemas)
!(import! &self ruleSampler)

!(import! &self pln/inference/deduction)
!(import! &self pln/inference/induction)
!(import! &self pln/inference/abduction)
!(import! &self pln/inference/conjunction)
!(import! &self pln/formula)
!(import! &self pln/utils)
!(import! &self pln/engine)

!(import! &self pln/rule/inference-utils)
!(import! &self pln/rule/helpers)


(= (loop $contexts $money $ruleSpace $depth) (
    (if (== $depth 0)
        (println! "Reached max depth")
        (let* (
            ($rules (collapse (get-atoms $ruleSpace)))
            ($sampledRules (ruleSampler $rules 20))
            ($reasonedRules (pln-reasoning $sampledRules))

            ; ($rules (collapse (get-atoms $ruleSpace)))
            ; ($reasonedRules (pln-reasoning $rules))
            ($_ (collapse (let $rule (superpose $reasonedRules) (add-atom $ruleSpace $rule))))
            ($combinedRules (collapse (get-atoms $ruleSpace)))
            ($_ (println! (Combined Rules: (size-atom $combinedRules))))
            ($applicableRules (getApplicableRules $contexts $money $combinedRules))
            ($_ (println! (Applicable Rules: (size-atom $applicableRules))))
            (($score $selectedRule) (thompson-sample $applicableRules))
            ($_ (println! ("Selected Rule:"  $selectedRule with score: $score)))
            (($newContexts $newMoney) (applyRule $selectedRule $contexts $money))
            ($_ (println! (Updated: $newContexts $newMoney)))
            ($oldStateValue (evaluateState $contexts $money))
            ($_ (println! (Old State Value: $oldStateValue)))
            ($newStateValue (evaluateState $newContexts $newMoney))
            ($_ (println! (New State Value: $newStateValue)))
            ($reward (- $newStateValue $oldStateValue))
            ($_ (println! (Reward: $reward)))
            ($updatedRule (updateRule $selectedRule $reward))
            ($_ (collapse (updateAtom $selectedRule $updatedRule $ruleSpace)))
        )
    (loop $newContexts $newMoney $ruleSpace (- $depth 1))))
))

!("Loop Started")
!(bind! &ruleSpace (new-space))
!(initializeSpace &ruleSpace)

!(loop (((PLANET A) (STV 0.2 0.1))) 100 &ruleSpace 5)